#!/usr/bin/env nix-shell
#!nix-shell -i bash -p alejandra git rsync

set -euo pipefail  # Exit on error, undefined vars, and pipe failures

# Set variables for directories
REPO_DIR="$HOME/.dotfiles"
NIXOS_DIR="/etc/nixos"
LOG_FILE="$HOME/.nixos-rebuild.log"

# Set default values for options
REBOOT=false
# SAVE_PLASMA=false  # Plasma/KDE no longer used
UPDATE=false
DRY_RUN=false

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Helper functions
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# Parse optional arguments
while getopts "rpuUdh" opt; do
    case ${opt} in
        r)
            REBOOT=true
            ;;
        # p)  # Plasma/KDE no longer used
        #     SAVE_PLASMA=true
        #     ;;
        u|U)
            UPDATE=true
            ;;
        d)
            DRY_RUN=true
            ;;
        h)
            echo "Usage: $0 [-r] [-p] [-u|-U] [-d] [-h]"
            echo ""
            echo "NixOS rebuild script for managing system configuration"
            echo ""
            echo "Options:"
            echo "  -r        Reboot after successful rebuild"
            # echo "  -p        Save Plasma desktop configuration"  # Plasma/KDE no longer used
            echo "  -u, -U    Update flake inputs before rebuild"
            echo "  -d        Perform a dry run (test without applying)"
            echo "  -h        Show this help message"
            exit 0
            ;;
        *)
            echo "Usage: $0 [-r] [-p] [-u|-U] [-d] [-h]"
            echo "Use -h for detailed help"
            exit 1
            ;;
    esac
done

# ============================================================================
# Main Script
# ============================================================================

# Navigate to the repository directory
cd "$REPO_DIR" || {
    log_error "Failed to navigate to $REPO_DIR"
    exit 1
}

log_step "Working in repository: $REPO_DIR"

# Save Plasma config if requested (Plasma/KDE no longer used)
# if [ "$SAVE_PLASMA" = true ]; then
#     log_step "Saving Plasma configuration..."
#     if nix run github:nix-community/plasma-manager > ./home/plasma.nix 2>/dev/null; then
#         log_info "Plasma config saved to ./home/plasma.nix"
#     else
#         log_warn "Failed to save Plasma config"
#     fi
# fi

# Format all Nix files using Alejandra
log_step "Formatting Nix files with Alejandra..."
if find . -name "*.nix" -not -path "./tools/*" -not -path "./.venv/*" -type f -exec alejandra {} + 2>/dev/null; then
    log_info "Nix files formatted successfully"
else
    log_warn "Some files could not be formatted"
fi

# Copy files to /etc/nixos (excluding unnecessary files)
log_step "Syncing configuration files to $NIXOS_DIR..."
if sudo rsync -av --delete --force \
    --exclude='.git' \
    --exclude='.gitignore' \
    --exclude='tools/' \
    --exclude='.venv/' \
    --exclude='*.log' \
    --exclude='*.backup' \
    --exclude='.DS_Store' \
    --exclude='README.md' \
    --exclude='LICENSE' \
    "$REPO_DIR/" "$NIXOS_DIR/"; then
    log_info "Files synced successfully"
else
    log_error "Failed to sync files to $NIXOS_DIR"
    exit 1
fi

# Reset ownership and permissions for /etc/nixos
log_step "Setting ownership and permissions for $NIXOS_DIR..."
sudo chown -R root:root "$NIXOS_DIR"
sudo find "$NIXOS_DIR" -type d -exec chmod 755 {} +
sudo find "$NIXOS_DIR" -type f -exec chmod 644 {} +

# Update flake inputs if requested
if [ "$UPDATE" = true ]; then
    log_step "Updating flake inputs..."
    if sudo nix flake update --flake "$NIXOS_DIR"; then
        log_info "Flake inputs updated successfully"
    else
        log_error "Failed to update flake inputs"
        exit 1
    fi

    log_step "Checking flake validity..."
    if sudo nix flake check "$NIXOS_DIR" --all-systems 2>&1 | tee -a "$LOG_FILE"; then
        log_info "Flake check passed"
    else
        log_error "Flake check failed"
        exit 1
    fi
else
    log_info "Skipping flake update (use -u to update)"
fi

# Perform dry run if requested
if [ "$DRY_RUN" = true ]; then
    log_step "Performing dry run of NixOS rebuild..."
    sudo nixos-rebuild dry-run --flake "$NIXOS_DIR"
    log_info "Dry run complete"
    exit 0
fi

# Rebuild NixOS with the new configuration
log_step "Rebuilding NixOS configuration..."
echo "This may take a while..."

if sudo nixos-rebuild switch --flake "$NIXOS_DIR" 2>&1 | tee "$LOG_FILE"; then
    echo ""
    log_info "✓ Rebuild completed successfully!"

    # Get the current generation info using nix-env
    GENERATION_INFO=$(sudo nix-env --list-generations --profile /nix/var/nix/profiles/system 2>/dev/null | grep current | tail -n1 || echo "")

    if [ -n "$GENERATION_INFO" ]; then
        GENERATION_NUM=$(echo "$GENERATION_INFO" | awk '{print $1}')
        log_info "Current generation: #$GENERATION_NUM"

        # Return to repo directory and commit the successful rebuild
        cd "$REPO_DIR"

        # Stage any changes and commit
        git add -A

        # Create a detailed commit message
        COMMIT_MSG="NixOS generation #$GENERATION_NUM"

        if [ "$UPDATE" = true ]; then
            COMMIT_MSG="$COMMIT_MSG (flake updated)"
        fi

        if git commit -m "$COMMIT_MSG" 2>/dev/null; then
            log_info "✓ Changes committed: $COMMIT_MSG"
        else
            log_info "No changes to commit"
        fi
    else
        log_warn "Could not retrieve generation information"
    fi

    log_info "Full log available at: $LOG_FILE"
else
    echo ""
    log_error "✗ Rebuild failed!"
    log_error "Check the log file for details: $LOG_FILE"

    # Show recent error messages
    if grep -qi "error" "$LOG_FILE"; then
        echo ""
        log_error "Recent error messages:"
        echo "----------------------------------------"
        grep -i "error" "$LOG_FILE" | tail -10
        echo "----------------------------------------"
    fi

    exit 1
fi

# Reboot if requested
if [ "$REBOOT" = true ]; then
    echo ""
    log_warn "⚠ Rebooting system in 5 seconds... (Press Ctrl+C to cancel)"
    for i in {5..1}; do
        echo -n "$i... "
        sleep 1
    done
    echo ""
    log_info "Rebooting now..."
    sudo reboot
else
    echo ""
    log_info "✓ All done! System is ready to use."
    log_info "  Tip: Use 'rebuild -r' to reboot after rebuild"
fi
